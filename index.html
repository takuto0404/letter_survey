<script>
window.addEventListener('load', () => {
  try {
    let global_meta = { text_label: null, g2048_score: null, g2048_moves: null };

    const jsPsych = initJsPsych({
      on_finish: async () => {
        try {
          // 自由記述テスト（page:4）だけ抽出
          const lastTestData = jsPsych.data.get().filter({page: 4}).values();
          const testResults = lastTestData.map(trial => {
            const responses = JSON.parse(trial.responses);
            const question_id = Object.keys(responses)[0];
            const value = responses[question_id];
            return { question_id, value };
          });

          // Google Apps Script に送信
          const payload = {
            timestamp: new Date().toISOString(),
            test_results: testResults
          };

          await fetch(SUBMIT_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
            mode: 'no-cors'
          });

          console.log('自由記述テスト結果:', testResults);
          toastOK('自由記述テスト結果を送信しました！');
        } catch (err) {
          showErr('結果の送信に失敗: ' + err.message);
        }
      }
    });

    /* ===== 2048ブロック作成（改良版） ===== */
    function make2048Block() {
      let board = Array.from({length:4},()=>Array(4).fill(0));
      let score = 0, moves = 0, gameOver = false;

      function randEmpty(){const e=[];for(let r=0;r<4;r++)for(let c=0;c<4;c++)if(board[r][c]===0)e.push([r,c]);return e.length?e[Math.floor(Math.random()*e.length)]:null;}
      function spawn(n=1){for(let k=0;k<n;k++){const cell=randEmpty();if(!cell)return;const[r,c]=cell;board[r][c]=(Math.random()<0.9)?2:4;}}
      function slideRow(row){const a=row.filter(x=>x!==0);let out=[],s=0;for(let i=0;i<a.length;i++){if(i<a.length-1&&a[i]===a[i+1]){const v=a[i]*2;out.push(v);s+=v;i++;}else out.push(a[i]);}while(out.length<4)out.push(0);return{row:out,gain:s};}
      function move(dir){
        let b=board.map(r=>r.slice()),total=0,moved=false;
        if(dir==='R') b=b.map(r=>r.reverse());
        if(dir==='U') b=rotateCCW(b);
        if(dir==='D') b=rotateCW(b);
        let nb=[];
        for(let r=0;r<4;r++){const{row,gain}=slideRow(b[r]);if(gain>0)total+=gain;if(row.some((v,i)=>v!==b[r][i]))moved=true;nb.push(row);}
        if(dir==='R') nb=nb.map(r=>r.reverse());
        if(dir==='U') nb=rotateCW(nb);
        if(dir==='D') nb=rotateCCW(nb);
        return{nb,gain:total,moved};
      }
      function anyMoves(b){for(let r=0;r<4;r++)for(let c=0;c<4;c++)if(b[r][c]===0)return true;const dirs=[[1,0],[0,1]];for(let r=0;r<4;r++)for(let c=0;c<4;c++){for(const[dr,dc]of dirs){const r2=r+dr,c2=c+dc;if(r2<4&&c2<4&&b[r][c]===b[r2][c2])return true;}}return false;}
      function tileBg(v){if(!v)return'#e5e7eb';const hue=40+Math.log2(v)*14;return `hsl(${hue},90%,75%)`; }

      function render(){
        let html = `<div class="board" id="g2048-grid">`;
        for(let r=0;r<4;r++){for(let c=0;c<4;c++){const v=board[r][c]; html += `<div class="tile" style="background:${tileBg(v)}">${v||''}</div>`;}}
        html += `</div>`;
        if(gameOver){
          html += `
            <div style="margin-top:12px; text-align:center;">
              <div class="muted" style="font-weight:700">ゲームオーバー！ スコア: ${score}</div>
              <div class="actions" style="margin-top:10px;">
                <button class="btn btn-primary" id="g2048-next" type="button">次へ</button>
              </div>
            </div>
          `;
        }
        const root=document.getElementById('g2048-board');
        if(root) root.innerHTML = html;
      }

      function handler(e){
        const k=e.key;
        if(!['ArrowLeft','ArrowRight','ArrowUp','ArrowDown','a','d','w','s','h','l','k','j'].includes(k)) return;
        e.preventDefault();
        const dir=(k==='ArrowLeft'||k==='a'||k==='h')?'L':(k==='ArrowRight'||k==='d'||k==='l')?'R':(k==='ArrowUp'||k==='w'||k==='k')?'U':'D';
        const {nb,gain,moved}=move(dir); if(!moved) return;
        board=nb; score+=gain; moves++; spawn(1); render();
        if(!anyMoves(board)){ gameOver=true; render(); }
      }

      function restart(){
        board = Array.from({length:4},()=>Array(4).fill(0));
        score = 0; moves = 0; gameOver = false;
        spawn(2); render();
        document.addEventListener('keydown', handler, true);
      }

      return {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
          <div class="container">
            <div class="card">
              <h2 class="headline">2048（8分）</h2>
              <p class="muted">矢印キー（または WASD / HJKL／スワイプ）で操作。</p>
              <div style="display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;">
                <div class="muted">スコア: <span id="g2048-score">0</span> 手数: <span id="g2048-moves">0</span></div>
              </div>
              <div id="g2048-board"></div>
            </div>
          </div>`,
        choices: "NO_KEYS",
        on_load: () => {
          spawn(2); render();
          document.addEventListener('keydown', handler, true);

          // ボタンで次へ
          document.addEventListener('click', (ev) => {
            if(ev.target?.id==='g2048-next'){
              global_meta.g2048_score = score;
              global_meta.g2048_moves = moves;
              jsPsych.finishTrial({score, moves, text_label: global_meta.text_label});
            }
            if(ev.target?.id==='g2048-restart'){ ev.preventDefault(); restart(); }
          }, true);
        },
        on_finish: () => {
          document.removeEventListener('keydown', handler, true);
        }
      };
    }

    const forgetting_block = make2048Block();

    /* ===== 実行 ===== */
    jsPsych.run([page1, page2, forgetting_block, page3_intro, ...textBlocks]);

  } catch (err) {
    showErr('Setup Error: ' + err.message);
    console.error(err);
  }
});
</script>
