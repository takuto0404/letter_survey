<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>文字の特徴に関する調査</title>

  <!-- jsPsych 本体とCSS（CDN） -->
  <script src="https://unpkg.com/jspsych@7.3.1" defer></script>
  <link href="https://unpkg.com/jspsych@7.3.1/css/jspsych.css" rel="stylesheet" />

  <!-- プラグイン -->
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.2" defer></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.2" defer></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice@1.1.2" defer></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-likert@1.1.2" defer></script>

  <style>
    :root{
      /* ダークでもコントラストが出る配色に調整 */
      --bg:#0f172a;          /* 背景 */
      --surface:#121a33;     /* サーフェス */
      --card:#0b1227;        /* カード */
      --panel:#0e152b;       /* 左パネル */
      --muted:#9db2cf;       /* 補助テキスト */
      --border:rgba(255,255,255,.12);
      --fg:#f1f5f9;          /* 本文色 */
      --fg-strong:#ffffff;   /* 強めの本文色 */
      --accent:#22d3ee;      /* ボタン */
      --accent-2:#06b6d4;
      --danger:#ef4444;
    }
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1000px 700px at 20% -10%, #0b132b 10%, transparent 40%),
                  radial-gradient(900px 700px at 120% 20%, #081125 10%, transparent 40%),
                  var(--bg);
      color:var(--fg);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    }
    .container{min-height:100dvh; display:grid; place-items:center; padding:24px;}
    .card{
      width:min(980px, 96vw);
      background:linear-gradient(180deg, rgba(255,255,255,.02), transparent 40%),
                 linear-gradient(180deg, rgba(255,255,255,.02), transparent 80%),
                 var(--card);
      border:1px solid var(--border);
      border-radius:20px; padding:28px;
      box-shadow:0 20px 60px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04);
    }
    .headline{font-size:28px; font-weight:800; letter-spacing:.2px; margin:0 0 10px; color:var(--fg-strong)}
    .muted{color:var(--muted)}

    .actions{display:flex; gap:12px; justify-content:center; margin-top:22px}
    .btn{
      appearance:none; border:0; cursor:pointer; border-radius:12px; padding:12px 18px; font-weight:700;
      transition:transform .06s ease, box-shadow .2s ease, background .2s ease, color .2s ease;
      box-shadow:0 8px 20px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.06);
    }
    .btn:active{transform:translateY(1px)}
    .btn-primary{background:linear-gradient(180deg, var(--accent), var(--accent-2)); color:#073948;}
    .btn-primary:hover{filter:saturate(110%) brightness(1.03)}
    .btn-ghost{background:transparent; color:var(--fg); border:1px solid var(--border);}
    .btn-ghost:hover{background:rgba(255,255,255,.04)}

    /* 読書ページの左右分割レイアウト */
    .split{
      display:grid; grid-template-columns: 360px 1fr; gap:18px;
      width:min(1200px, 96vw);
    }
    .panel{
      background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.04);
    }
    .panel h2{margin:0 0 8px; font-size:20px; color:var(--fg-strong)}
    .panel .hint{color:var(--muted); font-size:14px}
    .timer{
      margin-top:12px; background:rgba(2,6,23,.75); border:1px solid var(--border);
      border-radius:12px; padding:10px 14px; font-variant-numeric: tabular-nums; display:inline-block;
    }
    .docwrap{
      background:var(--surface); border:1px solid var(--border); border-radius:16px; padding:12px;
      height:70vh; display:flex; flex-direction:column; gap:10px;
    }
    .docwrap header{display:flex; justify-content:space-between; align-items:center}
    .docframe{
      flex:1; border:0; width:100%; border-radius:10px; background:#111827;
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.04);
    }
    .badge{display:inline-flex; align-items:center; gap:6px; font-size:12px; color:var(--muted)}
    .kbd{
      border:1px solid var(--border); background:rgba(255,255,255,.07); padding:2px 6px; border-radius:6px; font-family:ui-monospace, SFMono-Regular, Menlo, monospace;
    }

    /* 2048 */
    .board-wrap{margin-top:14px}
    .board{
      display:grid; grid-template-columns:repeat(4,1fr); gap:12px;
      background:rgba(255,255,255,.05); border:1px solid var(--border); border-radius:14px; padding:12px;
    }
    .tile{
      height:78px; display:flex; align-items:center; justify-content:center;
      border-radius:12px; font:800 24px/1.2 "Noto Sans JP", system-ui;
      color:#0b1227; box-shadow:inset 0 1px 0 rgba(255,255,255,.18), 0 6px 18px rgba(0,0,0,.25);
    }

    /* 起動/エラーバー */
    #boot-status{
      position:fixed; inset:12px auto auto 12px; background:rgba(2,6,23,.7);
      border:1px solid var(--border); color:var(--muted); padding:8px 10px; font:12px/1.4 monospace; border-radius:10px; z-index:99998;
    }
    .errbar{
      position:fixed; left:0; right:0; bottom:0; background:#3f1f1f; border-top:1px solid #8b2c2c; color:#fff;
      padding:10px 12px; font:12px/1.4 monospace; z-index:99999; white-space:pre-wrap;
    }
    .okbar{
      position:fixed; left:50%; transform:translateX(-50%); bottom:14px; background:#123524;
      border:1px solid rgba(16,185,129,.5); color:#d1fae5; padding:8px 12px; font:12px/1.4 monospace; border-radius:10px; z-index:99999;
    }
  </style>

  <script>
    /* ====== 設定：スプレッドシート送信先（Apps Script の WebApp URL）====== */
    const SUBMIT_ENDPOINT = "https://script.google.com/macros/s/AKfycbxyjf5wWZChnsx5N2-tVi31XG1BR4TRCyZUBbnDwOJJnjVy5KeJ5lY-slww4kV9aqqY/exec";
    /* ======================================================================= */

    (function(){
      const t=document.createElement('div');
      t.id='boot-status'; t.textContent='[boot] Loading...';
      document.addEventListener('DOMContentLoaded',()=>document.body.appendChild(t));
    })();
    function showErr(msg){
      const d=document.createElement('div'); d.className='errbar';
      d.textContent='Error: '+msg; document.body.appendChild(d);
      console.error('[overlay]',msg);
    }
    function toastOK(msg){
      const d=document.createElement('div'); d.className='okbar';
      d.textContent=msg; document.body.appendChild(d);
      setTimeout(()=>d.remove(),3000);
    }
    window.addEventListener('error',e=>{
      if(e.target&&(e.target.tagName==='SCRIPT'||e.target.tagName==='LINK')){
        showErr('Resource load failed: '+(e.target.src||e.target.href));
      }else if(e.message){ showErr(e.message); }
    },true);
    window.addEventListener('unhandledrejection',e=>{
      showErr('Unhandled rejection: '+(e.reason&&e.reason.message||e.reason));
    });
    let bootWatch=setTimeout(()=>{
      showErr('Boot timeout: jsPsych またはプラグインの読み込みが完了しません。ネットワークやURLを確認してください。');
    },5000);

    const GDOC_IFRAMES=[
      "https://docs.google.com/document/d/16PcG459Gez69Wuk9n7HKFDRUnDSMIq0wM9JdU_vveVM/edit?usp=sharing",
      "https://docs.google.com/document/d/1-d_yNvnLFwAW1aBIzggB7rFq1ETDtucUt74Gumawu3A/edit?usp=sharing",
      "https://docs.google.com/document/d/1YuVn0ES_T0E-YIg3IDq7Uvzx90vBf_H0m4-DLFNWfzs/edit?usp=sharing",
      "https://docs.google.com/document/d/1mbgmeo2_-Tsk6GsHZa4NmT7Tz7-TNkE45GHpIw8x4ww/edit?usp=sharing"
    ];
    function gdocSrc(raw){
      try{ const u=new URL(raw);
        if(!u.searchParams.get('embedded')) u.searchParams.set('embedded','true');
        return u.toString();
      }catch{return raw}
    }
    function startTimer(msTotal, mount){
      const el=document.createElement('div'); el.className='timer';
      (mount||document.body).appendChild(el);
      const t0=performance.now();
      const fmt=ms=>{const s=Math.max(0,Math.ceil(ms/1000));const m=Math.floor(s/60);const r=s%60;return `${String(m).padStart(1,'0')}:${String(r).padStart(2,'0')}`};
      el.textContent='残り '+fmt(msTotal);
      const h=setInterval(()=>{
        const dt=performance.now()-t0; const remain=msTotal-dt;
        el.textContent='残り '+fmt(remain);
        if(remain<=0){ clearInterval(h); el.textContent='残り 00:00'; setTimeout(()=>el.remove(),800) }
      },250);
      return()=>{ clearInterval(h); el.remove(); }
    }

    // Enterでアンケートがクラッシュしない/気持ちよく進むための共通ハンドラ
    //  - 入力欄にフォーカスがあるときは邪魔しない
    //  - それ以外は .jspsych-btn をクリック扱い
    document.addEventListener('keydown', (e)=>{
      if(e.key!=='Enter') return;
      const t=e.target;
      const tag=(t?.tagName||'').toLowerCase();
      const type=(t?.type||'').toLowerCase();
      const isTyping = tag==='textarea' || (tag==='input' && !['checkbox','radio','button','submit'].includes(type)) || t?.isContentEditable;
      if(isTyping) return; // 入力中は何もしない
      const btn=document.querySelector('.jspsych-btn');
      if(btn){
        e.preventDefault();
        btn.click();
      }
    }, true);
  </script>
</head>
<body>
  <noscript>このページはJavaScriptを使用します。ブラウザでJavaScriptを有効にしてください。</noscript>

  <script>
  window.addEventListener('load',()=>{try{
    // プラグイン存在チェック
    document.getElementById('boot-status').textContent='[boot] Loaded. Checking globals...';
    if(typeof initJsPsych!=='function') throw new Error('initJsPsych が見つかりません（jsPsych本体未読込）');
    if(typeof jsPsychHtmlKeyboardResponse==='undefined') throw new Error('jsPsychHtmlKeyboardResponse が見つかりません');
    if(typeof jsPsychSurveyText==='undefined') throw new Error('jsPsychSurveyText が見つかりません');
    if(typeof jsPsychSurveyMultiChoice==='undefined') throw new Error('jsPsychSurveyMultiChoice が見つかりません');
    if(typeof jsPsychSurveyLikert==='undefined') throw new Error('jsPsychSurveyLikert が見つかりません');

    clearTimeout(bootWatch);
    document.getElementById('boot-status').textContent='[boot] All good. Starting experiment...';

    /* ===== jsPsych 初期化（終了時はSheetsへ送信） ===== */
    const jsPsych=initJsPsych({
      on_finish: async ()=>{
        try{
          const payload = {
            timestamp: new Date().toISOString(),
            userAgent: navigator.userAgent,
            // 収集データ（CSVとJSONの両方を必要に応じて送れるように）
            csv: jsPsych.data.get().csv(),
            json: jsPsych.data.get().json()
          };
          const res = await fetch(SUBMIT_ENDPOINT, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify(payload),
            mode: 'no-cors' // WebAppをAnyoneに公開していれば no-cors でも投げられる（レスポンスは読めない）
          });
          toastOK('結果を送信しました。ご協力ありがとうございます！');
        }catch(err){
          showErr('結果の送信に失敗しました: '+err.message);
        }finally{
          // 任意：結果の簡易表示（デバッグ時はコメントアウトを外す）
          // jsPsych.data.displayData();
        }
      }
    });

    /* ========== Page 1: 同意＆開始 ========== */
    const page1={
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <div class="container">
          <div class="card">
            <h1 class="headline">文字の特徴に関する調査へようこそ</h1>
            <p class="muted">
              本調査は、文字の見た目や表記の違いが記憶に及ぼす影響を検討することを目的としています。<br>
              調査は<strong>任意参加</strong>で、途中で中止しても不利益はありません。<br>
              <strong>途中でページを閉じる・リロード・他タブへ移動</strong>した場合、それまでの結果は保存されません。
            </p>
            <p class="muted">
              所要時間は<strong>約12分</strong>です。準備ができたら「Enter」または「開始」を押してください。
            </p>
            <div class="actions">
              <button class="btn btn-primary" id="start-btn" type="button">開始</button>
            </div>
          </div>
        </div>`,
      choices:['Enter'],
      on_load:()=>{document.getElementById('start-btn')?.addEventListener('click',()=>jsPsych.finishTrial());},
      data:{page:1}
    };

    /* ========== Page 2: 読解（左右分割＋タイマー） ========== */
    const READ_MS=120000;
    const idx=jsPsych.randomization.sampleWithoutReplacement([...GDOC_IFRAMES.keys()],1)[0];
    let cleanupTimer=null;

    const page2={
      type: jsPsychHtmlKeyboardResponse,
      stimulus: () => `
        <div class="split" aria-label="読書画面">
          <aside class="panel" aria-label="指示とタイマー">
            <h2>読解（2分）</h2>
            <p class="hint">右側の文章を読み、内容を頭に入れてください。<br>時間になると自動で次へ進みます。</p>
            <div id="timer-slot"></div>
            <div style="margin-top:12px;">
              <span class="badge"><span class="kbd">↑↓←→</span> スクロールは右パネル内で</span>
            </div>
            <hr style="margin:14px 0;border:none;border-top:1px solid var(--border);" />
            <div class="muted">本文ID: #${idx+1}</div>
          </aside>
          <section class="docwrap" aria-label="本文">
            <header>
              <div class="muted">表示文章</div>
              <div class="badge"><span class="kbd">Enter</span> でも次へ</div>
            </header>
            <iframe class="docframe" src="${gdocSrc(GDOC_IFRAMES[idx])}"
              referrerpolicy="no-referrer-when-downgrade"
              sandbox="allow-same-origin allow-scripts allow-popups allow-forms"></iframe>
          </section>
        </div>
      `,
      choices:'NO_KEYS',
      trial_duration: READ_MS,
      on_load:()=>{ const slot=document.getElementById('timer-slot'); cleanupTimer=startTimer(READ_MS, slot); },
      on_finish:()=>{ cleanupTimer&&cleanupTimer(); },
      data:{page:2,text_index:idx}
    };

    /* ========== 忘却フェーズ：2048（8分） ========== */
    const FORGET_MS = 8*60*1000;
    function make2048Block() {
      let board = Array.from({length:4},()=>Array(4).fill(0));
      let score = 0, moves = 0, maxTile = 0, cleanup=null, ended=false;

      function randEmpty() {
        const e=[]; for(let r=0;r<4;r++)for(let c=0;c<4;c++) if(board[r][c]===0) e.push([r,c]);
        return e.length?e[Math.floor(Math.random()*e.length)]:null;
      }
      function spawn(n=1){
        for(let k=0;k<n;k++){ const cell = randEmpty(); if(!cell) return;
          const [r,c]=cell; board[r][c] = Math.random()<0.9?2:4;
        }
      }
      function rotate(b){const n=4,nb=Array.from({length:n},()=>Array(n).fill(0));for(let r=0;r<n;r++)for(let c=0;c<n;c++)nb[c][n-1-r]=b[r][c];return nb;}
      function slideRow(row){
        const a=row.filter(x=>x!==0); let out=[],s=0;
        for(let i=0;i<a.length;i++){
          if(i<a.length-1&&a[i]===a[i+1]){const v=a[i]*2; out.push(v); s+=v; i++;}
          else out.push(a[i]);
        }
        while(out.length<4) out.push(0);
        return{row:out,gain:s};
      }
      function move(dir){
        let b=board.map(r=>r.slice()),total=0;
        if(dir==='R') b=b.map(r=>r.reverse());
        if(dir==='U') b=rotate(b);
        if(dir==='D') b=rotate(rotate(rotate(b)));
        let moved=false,nb=[];
        for(let r=0;r<4;r++){
          const{row,gain}=slideRow(b[r]); if(gain>0) total+=gain;
          if(row.some((v,i)=>v!==b[r][i])) moved=true; nb.push(row);
        }
        if(dir==='R') nb=nb.map(r=>r.reverse());
        if(dir==='U') nb=rotate(rotate(rotate(nb)));
        if(dir==='D') nb=rotate(nb);
        return{nb,gain:total,moved};
      }
      function anyMoves(b){
        for(let r=0;r<4;r++)for(let c=0;c<4;c++) if(b[r][c]===0) return true;
        const dirs=[[1,0],[0,1]];
        for(let r=0;r<4;r++)for(let c=0;c<4;c++){
          for(const[dr,dc]of dirs){const r2=r+dr,c2=c+dc;
            if(r2<4&&c2<4&&b[r][c]===b[r2][c2]) return true;
          }
        }
        return false;
      }
      function render(){
        let html = `
          <div style="display:flex; gap:16px; align-items:center; justify-content:center; flex-wrap:wrap;">
            <div class="muted">スコア: <span id="g2048-score">${score}</span></div>
            <div class="muted">手数: <span id="g2048-moves">${moves}</span></div>
            <div class="muted">8分経過で自動で次へ進みます</div>
          </div>
          <div class="board-wrap">
            <div class="board">
        `;
        for(let r=0;r<4;r++){
          for(let c=0;c<4;c++){
            const v=board[r][c];
            const bg=v?`hsl(${40+Math.log2(v)*18},85%,70%)`:'rgba(255,255,255,.06)';
            const fw=v>=1024?'900':(v>=128?'800':'800');
            html += `<div class="tile" style="background:${bg};font-weight:${fw}">${v||''}</div>`;
          }
        }
        html += `</div></div>`;
        document.getElementById('g2048-board').innerHTML = html;
      }
      function finish(){
        if(ended) return; ended=true; cleanup&&cleanup();
        document.removeEventListener('keydown',handler,true);
        let mx=0; for(let r=0;r<4;r++)for(let c=0;c<4;c++) mx=Math.max(mx,board[r][c]); maxTile=mx;
        jsPsych.finishTrial({phase:'forgetting',game:'2048',score,moves,maxTile,duration_ms:FORGET_MS});
      }
      function handler(e){
        const k=e.key;
        if(!['ArrowLeft','ArrowRight','ArrowUp','ArrowDown','a','d','w','s','h','l','k','j'].includes(k)) return;
        e.preventDefault();
        const dir=(k==='ArrowLeft'||k==='a'||k==='h')?'L':(k==='ArrowRight'||k==='d'||k==='l')?'R':(k==='ArrowUp'||k==='w'||k==='k')?'U':'D';
        const{nb,gain,moved}=move(dir); if(!moved) return;
        board=nb; score+=gain; moves++;
        spawn(1); render(); if(!anyMoves(board)) finish();
      }
      return{
        type:jsPsychHtmlKeyboardResponse,
        stimulus:`
          <div class="container">
            <div class="card">
              <h2 class="headline">2048（8分）</h2>
              <p class="muted">矢印キー（または WASD / HJKL）で操作。時間内にスコアを伸ばしてみてください。</p>
              <div id="g2048">
                <div style="display:flex;gap:16px;align-items:baseline;margin-bottom:12px;">
                  <div class="muted">スコア: <span id="g2048-score">0</span></div>
                  <div class="muted">手数: <span id="g2048-moves">0</span></div>
                  <div class="muted">8分経過で自動で次へ進みます。</div>
                </div>
                <div id="g2048-board"></div>
              </div>
            </div>
          </div>`,
        choices:"NO_KEYS",
        on_load:()=>{spawn(2);render();document.addEventListener('keydown',handler,true);cleanup=startTimer(FORGET_MS);setTimeout(finish,FORGET_MS);},
        on_finish:()=>{cleanup&&cleanup();document.removeEventListener('keydown',handler,true);}
      };
    }
    const forgetting_block = make2048Block(); // ← 忘却フェーズは入っています

    /* ========== 質問群 ========== */
    const likert_labels = ["よし", "よろし", "わろし", "あし"];
    const QUESTION_BANK = {
      0: {
        multi: [
          { prompt: '本文の主題に最も近いものは？', options: ['歴史','技術','文化','自然'] },
          { prompt: '本文の語り口は？', options: ['説明的','叙情的','論説的','物語的'] }
        ],
        likert: [
          { prompt: '本文は理解しやすかった' },
          { prompt: '本文は印象に残った' },
          { prompt: '本文は興味深かった' }
        ],
        text: [
          { prompt: '本文の内容を一文で要約してください。' },
          { prompt: '特に記憶に残った箇所を挙げてください。' }
        ]
      },
      1: {
        multi: [
          { prompt: '本文に最も多く登場した対象は？', options: ['人物','場所','出来事','概念'] },
          { prompt: '本文の時代設定は？', options: ['古代','近世','近代','現代'] }
        ],
        likert: [
          { prompt: '本文は情報量が多かった' },
          { prompt: '本文は構成が分かりやすかった' },
          { prompt: '本文を思い出しやすい' }
        ],
        text: [
          { prompt: '本文の構成（導入・展開など）で良かった点は？' },
          { prompt: '紛らわしかった点があれば教えてください。' }
        ]
      },
      2: { multi: [], likert: [], text: [] },
      3: { multi: [], likert: [], text: [] },
      4: { multi: [], likert: [], text: [] },
      5: { multi: [], likert: [], text: [] }
    };

    function buildSurveyFor(textId) {
      const spec = QUESTION_BANK[textId] || QUESTION_BANK[0];
      const out = [];

      if (spec.multi?.length) {
        spec.multi.forEach((q, i) => {
          out.push({
            type: jsPsychSurveyMultiChoice,
            preamble: `<div class="card"><h2 class="headline">質問 ${i+1}</h2></div>`,
            questions: [{ prompt: q.prompt, name: `mc_q${i+1}`, options: q.options, required: true }],
            button_label: '次へ',
            data: { page: 3, kind: 'multi', text_id: textId, index: i+1 }
          });
        });
      }

      if (spec.likert?.length) {
        spec.likert.forEach((q, i) => {
          out.push({
            type: jsPsychSurveyLikert,
            preamble: `<div class="card"><h2 class="headline">質問 ${i+1+spec.multi.length}</h2></div>`,
            questions: [{ prompt: q.prompt, labels: likert_labels, name: `likert_q${i+1}`, required: true }],
            button_label: '次へ',
            data: { page: 3, kind: 'likert', text_id: textId, index: i+1 }
          });
        });
      }

      if (spec.text?.length) {
        spec.text.forEach((q, i) => {
          out.push({
            type: jsPsychSurveyText,
            preamble: `<div class="card"><h2 class="headline">質問 ${i+1+spec.multi.length+spec.likert.length}</h2></div>`,
            questions: [{ prompt: q.prompt, name: `text_q${i+1}`, required: false }],
            button_label: '次へ',
            data: { page: 3, kind: 'text', text_id: textId, index: i+1 }
          });
        });
      }

      return out;
    }

    const blocks = buildSurveyFor(idx);

    /* ========== Page 3: テスト導入 ========== */
    const page3_intro={
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <div class="container">
          <div class="card">
            <h2 class="headline">テスト</h2>
            <p class="muted">選択式・5件法・自由記述が含まれます。全問に回答してください。</p>
            <div class="actions" style="margin-top:24px;">
              <button class="btn btn-primary" id="go-q" type="button">開始する</button>
            </div>
          </div>
        </div>
      `,
      choices:['Enter'],
      on_load:()=>{ document.getElementById('go-q')?.addEventListener('click',()=>jsPsych.finishTrial()); },
      data:{page:3,part:'intro'}
    };

    jsPsych.run([page1,page2,forgetting_block,page3_intro,...blocks]);

  }catch(err){
    clearTimeout(bootWatch); showErr('Setup Error: '+err.message); console.error(err);
  }});
  </script>
</body>
</html>
